name: Release

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID of the CI workflow that built the wheels (optional - will use latest successful run if not provided)'
        required: false
        type: string
  release:
    types: [published]

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  release:
    name: Release to PyPI
    runs-on: ubuntu-latest
    steps:
      - name: Get artifacts from CI run
        uses: actions/github-script@v7  # TODO: Pin to commit SHA (see .github/ACTION_VERSIONS.md)
        id: get-run-id
        with:
          script: |
            const runId = '${{ inputs.run_id }}';

            if (runId) {
              console.log(`Using specified run ID: ${runId}`);
              return runId;
            }

            // Find the most recent successful CI run
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'maturin.yml',
              status: 'completed',
              conclusion: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              throw new Error('No successful CI runs found');
            }

            const latestRun = runs.data.workflow_runs[0];
            console.log(`Using latest successful run: ${latestRun.id}`);
            return latestRun.id;

      - name: Download artifacts from CI run
        uses: actions/download-artifact@v4  # TODO: Pin to commit SHA
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.get-run-id.outputs.result }}
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          find . -name "*.whl" -o -name "*.tar.gz" | sort

      - name: Verify artifact versions
        if: github.event_name == 'release'
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          VERSION="${RELEASE_TAG#v}"

          echo "Release tag: $RELEASE_TAG"
          echo "Expected version: $VERSION"

          # Check all wheels contain the correct version
          for wheel in *.whl; do
            if [[ ! "$wheel" =~ vtt_builder-${VERSION}- ]]; then
              echo "ERROR: Wheel $wheel does not match release version $VERSION"
              exit 1
            fi
          done

          # Check sdist contains the correct version
          for tarball in *.tar.gz; do
            if [[ ! "$tarball" =~ vtt_builder-${VERSION}\.tar\.gz ]]; then
              echo "ERROR: Source distribution $tarball does not match release version $VERSION"
              exit 1
            fi
          done

          echo "âœ“ All artifacts match release version $VERSION"

      - name: Install uv
        uses: astral-sh/setup-uv@v5  # TODO: Pin to commit SHA
        with:
          enable-cache: true

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2  # TODO: Pin to commit SHA
        with:
          subject-path: '**/*.whl'

      - name: Publish to PyPI
        run: |
          # uv publish supports both trusted publishing (OIDC) and token-based auth
          # If PYPI_API_TOKEN is not set, it will use trusted publishing automatically
          if [ -n "${{ secrets.PYPI_API_TOKEN }}" ]; then
            uv publish --token ${{ secrets.PYPI_API_TOKEN }}
          else
            uv publish
          fi
